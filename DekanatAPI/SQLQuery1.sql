USE master;
GO
IF DB_ID(N'Деканат') IS NULL
    CREATE DATABASE [Деканат];
GO
USE [Деканат];
GO

------------------------------------------------------
-- Очистка старых таблиц
------------------------------------------------------
IF OBJECT_ID('dbo.Все_Группы') IS NOT NULL DROP TABLE dbo.Все_Группы;
IF OBJECT_ID('dbo.Специальности') IS NOT NULL DROP TABLE dbo.Специальности;
IF OBJECT_ID('dbo.Факультеты') IS NOT NULL DROP TABLE dbo.Факультеты;
IF OBJECT_ID('dbo.ФормаОбучения') IS NOT NULL DROP TABLE dbo.ФормаОбучения;
IF OBJECT_ID('dbo.Уровень_образования') IS NOT NULL DROP TABLE dbo.Уровень_образования;
GO

------------------------------------------------------
-- Таблица: Факультеты
------------------------------------------------------
CREATE TABLE dbo.Факультеты (
    Код INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
    Факультет VARCHAR(250),
    Сокращение VARCHAR(20),
    Псевдоним VARCHAR(20),
    Тип_Обучения INT,
    ПК BIT,
    Декан VARCHAR(110)
);
GO

------------------------------------------------------
-- Таблица: Специальности
------------------------------------------------------
CREATE TABLE dbo.Специальности (
    Код INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
    Специальность VARCHAR(50),
    ОКСО VARCHAR(50),
    Название VARCHAR(1000),
    Прием BIT,
    Код_Факультета INT,
    Код_Кафедры INT,
    Квалификация VARCHAR(150),
    Название_Спец VARCHAR(1000),
    Срок_Обучения VARCHAR(50),
    Шифр VARCHAR(50),
    ОО INT,
    ЦН INT,
    СН INT,
    Всего INT,
    Цена7к DECIMAL(18,0),
    КодФормыОбучения INT,
    Префикс VARCHAR(50),
    Профиль BIT NOT NULL,
    КодРодителя INT
);
GO

------------------------------------------------------
-- Таблица: Все_Группы
------------------------------------------------------
CREATE TABLE dbo.Все_Группы (
    Код INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
    Название VARCHAR(50) NOT NULL,
    Учебный_План VARCHAR(255),
    Код_Специальности INT,
    Курс INT,
    Код_Факультета INT,
    УчебныйГод VARCHAR(50),
    Направление VARCHAR(300),
    Специальность VARCHAR(300),
    Специализации VARCHAR(300),
    Код_Подразделения INT,
    Удалена BIT,
    СрокОбучения VARCHAR(50),
    Уровень INT,
    Форма_Обучения INT
);
GO

------------------------------------------------------
-- Таблица: ФормаОбучения
------------------------------------------------------
CREATE TABLE dbo.ФормаОбучения (
    Код INT NOT NULL PRIMARY KEY,
    ФормаОбучения VARCHAR(50),
    Сокращение VARCHAR(50),
    Вывод BIT,
    Префикс VARCHAR(10),
    ТекстДляПриказа VARCHAR(100)
);
GO

------------------------------------------------------
-- Таблица: Уровень_образования
------------------------------------------------------
CREATE TABLE dbo.Уровень_образования (
    Код_записи INT NOT NULL PRIMARY KEY,
    Уровень VARCHAR(100)
);
GO

------------------------------------------------------
-- Тестовые данные
------------------------------------------------------

-- Форма обучения
INSERT INTO dbo.ФормаОбучения (Код, ФормаОбучения, Сокращение, Вывод, Префикс, ТекстДляПриказа) VALUES
(1, 'Очная форма', 'ОФ', 1, NULL, 'Очная форма'),
(2, 'Заочная форма', 'ЗФ', 1, 'z', 'Заочная форма'),
(3, 'Очно-заочная форма', 'ОЗО', 1, 'v', 'Очно-заочная форма');

-- Уровни образования
INSERT INTO dbo.Уровень_образования (Код_записи, Уровень) VALUES
(1, 'ВО-Специалисты'),
(2, 'ВО-Бакалавры'),
(3, 'ВО-Магистры'),
(7, 'Аспирантура'),
(10, 'Ординатура');

-- Факультеты
INSERT INTO dbo.Факультеты (Факультет, Сокращение, Псевдоним, Тип_Обучения, ПК, Декан) VALUES
('Факультет информатики', 'ФИ', 'INF', 1, 1, 'Иванов И.И.'),
('Факультет экономики', 'ФЭ', 'ECO', 1, 0, 'Петров П.П.'),
('Факультет медицины', 'ФМ', 'MED', 1, 1, 'Сидорова С.С.'),
('Факультет гуманитарных наук', 'ФГН', 'HUM', 1, 0, 'Кузнецов К.К.'),
('Факультет физики', 'ФФ', 'PHY', 1, 0, 'Литвинова Л.А.');

-- Специальности
INSERT INTO dbo.Специальности (Специальность, ОКСО, Название, Прием, Код_Факультета, Квалификация, Название_Спец, Срок_Обучения, Шифр, Цена7к, КодФормыОбучения, Префикс, Профиль)
VALUES
('Информатика и вычислительная техника', '09.03.01', 'Информатика', 1, 1, 'Бакалавр', 'Программист', '4 года', '09.03.01', 120000, 1, NULL, 0),
('Программная инженерия', '09.03.04', 'Программная инженерия', 1, 1, 'Бакалавр', 'Разработчик', '4 года', '09.03.04', 130000, 1, NULL, 0),
('Экономика', '38.03.01', 'Экономика', 1, 2, 'Бакалавр', 'Экономист', '4 года', '38.03.01', 100000, 2, 'z', 0),
('Менеджмент', '38.03.02', 'Менеджмент', 1, 2, 'Бакалавр', 'Менеджер', '4 года', '38.03.02', 110000, 1, NULL, 0),
('Лечебное дело', '31.05.01', 'Медицина', 1, 3, 'Специалист', 'Врач', '6 лет', '31.05.01', 180000, 1, NULL, 0),
('История', '46.03.01', 'История', 1, 4, 'Бакалавр', 'Историк', '4 года', '46.03.01', 90000, 1, NULL, 0),
('Философия', '47.03.01', 'Философия', 1, 4, 'Бакалавр', 'Философ', '4 года', '47.03.01', 90000, 2, 'z', 0),
('Физика', '03.03.02', 'Физика', 1, 5, 'Бакалавр', 'Физик', '4 года', '03.03.02', 110000, 1, NULL, 0);

------------------------------------------------------
-- 30 тестовых групп
------------------------------------------------------
DECLARE @i INT = 1;

WHILE @i <= 100
BEGIN
    INSERT INTO dbo.Все_Группы (
        Название, Учебный_План, Код_Специальности, Курс, Код_Факультета,
        УчебныйГод, Направление, Специальность, Специализации,
        Код_Подразделения, Удалена, СрокОбучения, Уровень, Форма_Обучения)
    SELECT 
        CASE 
            WHEN s.Код <= 2 THEN CONCAT('ФИ-', RIGHT(100+@i,2))
            WHEN s.Код BETWEEN 3 AND 4 THEN CONCAT('ФЭ-', RIGHT(100+@i,2))
            WHEN s.Код = 5 THEN CONCAT('ФМ-', RIGHT(100+@i,2))
            WHEN s.Код BETWEEN 6 AND 7 THEN CONCAT('ФГН-', RIGHT(100+@i,2))
            ELSE CONCAT('ФФ-', RIGHT(100+@i,2))
        END AS Название,
        CONCAT('План_', s.ОКСО, '_', @i),
        s.Код AS Код_Специальности,
        ((@i-1)%6)+1 AS Курс,
        s.Код_Факультета,
        CASE (@i % 3)
        WHEN 0 THEN '2023-2024'
        WHEN 1 THEN '2024-2025'
        ELSE '2025-2026'
        END AS УчебныйГод,
        s.Название AS Направление,
        s.Специальность,
        s.Название_Спец AS Специализации,
        s.Код_Факультета,
        0,
        s.Срок_Обучения,
        CASE 
      WHEN s.Квалификация='Бакалавр' THEN 2
      WHEN s.Квалификация='Специалист' THEN 1
      WHEN s.Квалификация='Магистр' THEN 3
      WHEN s.Квалификация LIKE '%аспирант%' THEN 4
      ELSE 5
      END,
        s.КодФормыОбучения
    FROM dbo.Специальности s
    WHERE s.Код = ((@i-1)%8)+1;
    SET @i += 1;
END

------------------------------------------------------
-- Проверка
------------------------------------------------------
SELECT COUNT(*) AS КоличествоГрупп FROM dbo.Все_Группы;
SELECT TOP 100 * FROM dbo.Все_Группы ORDER BY Код;
GO